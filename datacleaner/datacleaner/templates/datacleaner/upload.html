{% load static %}
<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Cleaner Pro â€” Nettoyage Intelligent de DonnÃ©es</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       VARIABLES LIGHT / DARK
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    :root {
        --primary:   #6f42c1;
        --secondary: #d63384;
        --success:   #20c997;
        --info:      #0dcaf0;
        --warning:   #ffc107;
        --danger:    #dc3545;
        --gradient:  linear-gradient(135deg,#667eea 0%,#764ba2 100%);
        --gradient-alt: linear-gradient(135deg,#f093fb 0%,#f5576c 100%);

        /* light defaults */
        --bg-body:   linear-gradient(135deg,#667eea 0%,#764ba2 100%);
        --bg-card:   #ffffff;
        --bg-section:#f8f9fa;
        --text-main: #212529;
        --text-muted:#666;
        --border-col:#ececec;
        --navbar-bg: rgba(255,255,255,0.95);
        --shadow:    0 10px 30px rgba(0,0,0,0.10);
    }
    [data-theme="dark"] {
        --bg-body:   linear-gradient(135deg,#1a1040 0%,#2d1b69 100%);
        --bg-card:   #1e1e2e;
        --bg-section:#252535;
        --text-main: #e8e8f0;
        --text-muted:#9a9ab0;
        --border-col:#333350;
        --navbar-bg: rgba(20,15,50,0.97);
        --shadow:    0 10px 30px rgba(0,0,0,0.40);
    }

    * { margin:0; padding:0; box-sizing:border-box; }

    body {
        background: var(--bg-body);
        font-family:'Poppins',sans-serif;
        min-height:100vh;
        overflow-x:hidden;
        transition: background 0.4s ease;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â• SCROLL PROGRESS BAR â•â•â•â•â•â•â•â•â•â•â•â• */
    #scrollBar {
        position:fixed; top:0; left:0; height:3px; width:0;
        background:linear-gradient(90deg,#f093fb,#667eea,#20c997);
        z-index:10001; transition:width .1s linear;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â• BACK TO TOP â•â•â•â•â•â•â•â•â•â•â•â• */
    #backToTop {
        position:fixed; bottom:28px; right:28px;
        width:44px; height:44px; border-radius:50%;
        background:var(--gradient); color:white; border:none;
        font-size:1.1rem; cursor:pointer;
        box-shadow:0 6px 20px rgba(103,126,234,.45);
        display:none; align-items:center; justify-content:center;
        transition:all 0.3s ease; z-index:999;
    }
    #backToTop.show { display:flex; }
    #backToTop:hover { transform:translateY(-4px) scale(1.08); }

    /* â•â•â•â•â•â•â•â•â•â•â•â• TOAST SYSTEM â•â•â•â•â•â•â•â•â•â•â•â• */
    .toast-stack {
        position:fixed; top:76px; right:18px;
        z-index:9998; display:flex; flex-direction:column; gap:10px;
        pointer-events:none;
    }
    .toast-item {
        background:var(--bg-card);
        border-radius:14px; padding:.9rem 1.1rem;
        box-shadow:0 8px 28px rgba(0,0,0,.18);
        display:flex; align-items:flex-start; gap:11px;
        min-width:290px; max-width:380px;
        border-left:4px solid var(--primary);
        pointer-events:all;
        animation:tIn .35s cubic-bezier(.16,1,.3,1) forwards;
    }
    .toast-item.t-error   { border-left-color:#dc3545; }
    .toast-item.t-success { border-left-color:#20c997; }
    .toast-item.t-warn    { border-left-color:#ffc107; }
    @keyframes tIn  { from{opacity:0;transform:translateX(50px)} to{opacity:1;transform:translateX(0)} }
    @keyframes tOut { from{opacity:1;transform:translateX(0)}    to{opacity:0;transform:translateX(50px)} }
    .ti-icon { font-size:1.3rem; flex-shrink:0; margin-top:2px; }
    .ti-body  { flex:1; }
    .ti-title { font-weight:700; font-size:.83rem; color:var(--text-main); }
    .ti-msg   { font-size:.79rem; color:var(--text-muted); line-height:1.4; margin-top:2px; }
    .ti-close { background:none; border:none; color:var(--text-muted); cursor:pointer; font-size:.95rem; padding:0; flex-shrink:0; }

    /* â•â•â•â•â•â•â•â•â•â•â•â• NAVBAR â•â•â•â•â•â•â•â•â•â•â•â• */
    .navbar {
        background:var(--navbar-bg);
        backdrop-filter:blur(14px);
        box-shadow:0 4px 30px rgba(0,0,0,.10);
        transition:background 0.4s;
    }
    .navbar-brand {
        font-weight:700; font-size:1.75rem;
        background:var(--gradient);
        -webkit-background-clip:text; -webkit-text-fill-color:transparent;
        background-clip:text;
    }
    .nav-link { font-weight:500; color:var(--text-muted) !important; transition:color .2s; }
    .nav-link:hover { color:var(--primary) !important; }

    /* Dark mode toggle */
    .dark-toggle {
        background:none; border:2px solid var(--border-col);
        border-radius:100px; padding:.3rem .75rem;
        cursor:pointer; font-size:.82rem; font-weight:600;
        color:var(--text-muted); display:flex; align-items:center; gap:6px;
        transition:all .3s ease;
    }
    .dark-toggle:hover { border-color:var(--primary); color:var(--primary); }

    /* â•â•â•â•â•â•â•â•â•â•â•â• HERO â•â•â•â•â•â•â•â•â•â•â•â• */
    .hero-section { padding:4rem 0 2rem; text-align:center; color:white; }
    .hero-title {
        font-size:3rem; font-weight:700; margin-bottom:1rem;
        animation:fadeInDown 1s ease-out, floatTitle 3s ease-in-out infinite;
    }
    @keyframes floatTitle { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-15px)} }
    .hero-subtitle { font-size:1.3rem; opacity:.95; margin-bottom:1.5rem; animation:fadeInUp 1s ease-out; }

    /* Format pills */
    .hero-pills { display:flex; flex-wrap:wrap; justify-content:center; gap:.5rem; margin-bottom:2rem; animation:fadeInUp 1.3s ease-out; }
    .hero-pill {
        background:rgba(255,255,255,.18); backdrop-filter:blur(8px);
        border:1px solid rgba(255,255,255,.35); color:white;
        font-size:.76rem; font-weight:600; padding:.28rem .82rem;
        border-radius:100px; letter-spacing:.4px;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â• GUIDE â•â•â•â•â•â•â•â•â•â•â•â• */
    .guide-section {
        background:rgba(255,255,255,.1); backdrop-filter:blur(10px);
        border-radius:20px; padding:2rem; margin-bottom:3rem; animation:fadeIn 1.2s ease-out;
    }
    .step-card {
        background:var(--bg-card); border-radius:15px; padding:1.5rem;
        margin-bottom:1rem; transition:all .3s ease; position:relative; overflow:hidden;
        box-shadow:var(--shadow);
    }
    .step-card::before { content:''; position:absolute; top:0; left:0; width:5px; height:100%; background:var(--gradient); transition:width .3s ease; }
    .step-card:hover   { transform:translateX(10px); box-shadow:0 10px 30px rgba(0,0,0,.18); }
    .step-card:hover::before { width:100%; opacity:.1; }
    .step-number {
        width:50px; height:50px; border-radius:50%; background:var(--gradient); color:white;
        display:flex; align-items:center; justify-content:center;
        font-weight:700; font-size:1.4rem; margin-right:1rem; flex-shrink:0;
    }
    .step-content h5 { color:var(--primary); font-weight:600; margin-bottom:.4rem; }
    .step-content p  { color:var(--text-muted); margin:0; font-size:.93rem; }

    /* â•â•â•â•â•â•â•â•â•â•â•â• MAIN CARD / UPLOAD â•â•â•â•â•â•â•â•â•â•â•â• */
    .main-card { background:var(--bg-card); border-radius:25px; box-shadow:0 20px 60px rgba(0,0,0,.25); overflow:hidden; margin-bottom:3rem; animation:fadeInUp 1s ease-out; }
    .card-header-custom { background:var(--gradient); color:white; padding:2rem; text-align:center; position:relative; overflow:hidden; }
    .card-header-custom::before { content:''; position:absolute; top:-50%; left:-50%; width:200%; height:200%; background:radial-gradient(circle,rgba(255,255,255,.1) 0%,transparent 70%); animation:pulse 3s ease-in-out infinite; }
    @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.1)} }
    .card-header-custom h2 { margin:0; font-size:2rem; font-weight:600; position:relative; z-index:1; }
    .card-header-custom p  { margin:.5rem 0 0; opacity:.9; position:relative; z-index:1; }

    /* â•â•â•â•â•â•â•â•â•â•â•â• DROP ZONE â•â•â•â•â•â•â•â•â•â•â•â• */
    .file-drop-zone {
        border:3px dashed #d0d0d0; border-radius:20px; padding:3rem 2rem; text-align:center;
        cursor:pointer; background:var(--bg-section);
        transition:all .4s ease; position:relative; overflow:hidden;
    }
    .file-drop-zone::before { content:''; position:absolute; top:50%; left:50%; width:0; height:0; border-radius:50%; background:rgba(103,126,234,.1); transform:translate(-50%,-50%); transition:all .5s ease; }
    .file-drop-zone:hover::before  { width:500px; height:500px; }
    .file-drop-zone:hover     { border-color:var(--primary); transform:translateY(-5px); box-shadow:0 15px 40px rgba(103,126,234,.2); }
    .file-drop-zone.dragover  { border-color:var(--secondary); background:linear-gradient(145deg,#f5f0ff,#fff5f8); transform:scale(1.02); }
    .file-drop-zone.has-error { border-color:#dc3545 !important; }
    .upload-icon  { font-size:4rem; color:var(--primary); margin-bottom:1rem; animation:bounce 2s infinite; position:relative; z-index:1; }
    @keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-15px)} }
    .file-drop-zone input[type="file"] { position:absolute; width:100%; height:100%; top:0; left:0; opacity:0; cursor:pointer; z-index:2; }
    .file-info { position:relative; z-index:1; }
    .file-name-display { margin-top:1rem; padding:1rem 1.25rem; background:rgba(103,126,234,.08); border-radius:12px; display:none; animation:fadeIn .4s ease; align-items:center; justify-content:space-between; gap:.75rem; }
    .file-name-display.show { display:flex; }
    .file-name-display .fname { font-weight:600; color:var(--primary); font-size:.92rem; }
    .file-size-tag { font-size:.72rem; background:rgba(111,66,193,.12); color:var(--primary); padding:.2rem .6rem; border-radius:100px; font-weight:600; white-space:nowrap; }

    /* â•â•â•â•â•â•â•â•â•â•â•â• METHOD CARDS â•â•â•â•â•â•â•â•â•â•â•â• */
    .method-section { margin:2rem 0; }
    .method-title   { color:var(--primary); font-weight:600; text-align:center; margin-bottom:2rem; }
    .method-grid    { display:grid; grid-template-columns:repeat(auto-fit,minmax(175px,1fr)); gap:1rem; }
    .method-option  { position:relative; }
    .method-option input[type="radio"] { position:absolute; opacity:0; }
    .method-label {
        display:block; padding:1.4rem 1rem; background:var(--bg-section);
        border:2px solid var(--border-col); border-radius:15px; text-align:center;
        cursor:pointer; transition:all .3s ease;
    }
    .method-label small { display:block; font-size:.72rem; color:var(--text-muted); margin-top:.45rem; line-height:1.35; }
    .method-option input[type="radio"]:checked + .method-label {
        background:var(--gradient); color:white; border-color:var(--primary);
        transform:translateY(-5px); box-shadow:0 10px 25px rgba(103,126,234,.35);
    }
    .method-option input[type="radio"]:checked + .method-label small { color:rgba(255,255,255,.82); }
    .method-label:hover { transform:translateY(-3px); box-shadow:0 5px 15px rgba(0,0,0,.1); }
    .method-icon { font-size:2rem; display:block; margin-bottom:.5rem; }

    /* â•â•â•â•â•â•â•â•â•â•â•â• SUBMIT â•â•â•â•â•â•â•â•â•â•â•â• */
    .btn-submit {
        background:var(--gradient); color:white; border:none;
        padding:1.2rem 3rem; font-size:1.2rem; font-weight:600;
        border-radius:50px; cursor:pointer; transition:all .3s ease;
        box-shadow:0 8px 25px rgba(103,126,234,.35); position:relative; overflow:hidden;
    }
    .btn-submit::before { content:''; position:absolute; top:50%; left:50%; width:0; height:0; border-radius:50%; background:rgba(255,255,255,.3); transform:translate(-50%,-50%); transition:all .6s ease; }
    .btn-submit:hover::before { width:400px; height:400px; }
    .btn-submit:hover { transform:translateY(-3px) scale(1.05); box-shadow:0 15px 40px rgba(103,126,234,.45); }
    .btn-submit:active { transform:translateY(0) scale(.98); }
    .btn-submit span { position:relative; z-index:1; }
    .btn-submit:disabled { opacity:.55; cursor:not-allowed; transform:none !important; }

    /* â•â•â•â•â•â•â•â•â•â•â•â• LOADING OVERLAY â•â•â•â•â•â•â•â•â•â•â•â• */
    .loading-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(8,5,30,.92); backdrop-filter:blur(10px); display:none; align-items:center; justify-content:center; z-index:9999; }
    .loading-overlay.show { display:flex; }
    .loading-box { background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1); border-radius:24px; padding:2.5rem 3rem; text-align:center; min-width:330px; }
    /* Double-ring spinner */
    .ring-wrap { width:72px; height:72px; margin:0 auto 1.5rem; position:relative; }
    .ring-wrap::before,.ring-wrap::after { content:''; position:absolute; inset:0; border-radius:50%; border:4px solid transparent; }
    .ring-wrap::before { border-top-color:#667eea; border-right-color:#764ba2; animation:spin 1s linear infinite; }
    .ring-wrap::after  { border-bottom-color:#20c997; border-left-color:#f093fb; animation:spin 1.5s linear infinite reverse; inset:10px; }
    @keyframes spin { to{transform:rotate(360deg)} }
    .load-steps { list-style:none; text-align:left; margin:1.2rem 0 1rem; padding:0; }
    .load-step  { display:flex; align-items:center; gap:.75rem; color:rgba(255,255,255,.35); font-size:.85rem; padding:.3rem 0; transition:all .4s ease; }
    .load-step.active { color:white; font-weight:600; }
    .load-step.done   { color:#20c997; }
    .ls-dot { width:20px; height:20px; border-radius:50%; border:2px solid currentColor; display:flex; align-items:center; justify-content:center; font-size:.65rem; flex-shrink:0; transition:all .4s ease; }
    .load-step.done .ls-dot   { background:#20c997; border-color:#20c997; }
    .load-step.active .ls-dot { border-color:#667eea; background:rgba(102,126,234,.25); animation:dotPulse 1s ease-in-out infinite; }
    @keyframes dotPulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.2)} }
    .load-timer { color:rgba(255,255,255,.4); font-size:.78rem; margin-top:.5rem; }

    /* â•â•â•â•â•â•â•â•â•â•â•â• RESULTS HEADER â•â•â•â•â•â•â•â•â•â•â•â• */
    .results-topbar { display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:.75rem; margin-bottom:1.5rem; }
    .results-topbar h2 { color:white; margin:0; font-size:1.8rem; font-weight:700; }

    /* â•â•â•â•â•â•â•â•â•â•â•â• KPI CARDS (individual colors) â•â•â•â•â•â•â•â•â•â•â•â• */
    .summary-section { margin:0 0 2rem; }
    .kpi-card {
        background:var(--bg-card); border-radius:18px; padding:1.6rem 1.25rem; text-align:center;
        box-shadow:var(--shadow); transition:all .3s ease;
        position:relative; overflow:hidden;
        border-top:5px solid var(--kc);
    }
    .kpi-card::after { content:''; position:absolute; bottom:-18px; right:-18px; width:75px; height:75px; border-radius:50%; background:var(--kc); opacity:.07; transition:transform .4s ease; }
    .kpi-card:hover { transform:translateY(-8px); box-shadow:0 20px 50px rgba(0,0,0,.18); }
    .kpi-card:hover::after { transform:scale(2.8); }
    .kpi-icon { width:48px; height:48px; border-radius:13px; display:flex; align-items:center; justify-content:center; margin:0 auto .8rem; font-size:1.4rem; color:var(--kc); background:color-mix(in srgb, var(--kc) 12%, transparent); }
    .kpi-value { font-size:2.2rem; font-weight:700; color:var(--text-main); margin:.2rem 0; line-height:1; }
    .kpi-label { color:var(--text-muted); font-size:.74rem; text-transform:uppercase; letter-spacing:1.1px; font-weight:600; }

    /* â•â•â•â•â•â•â•â•â•â•â•â• QUALITY SCORE â•â•â•â•â•â•â•â•â•â•â•â• */
    .quality-card {
        background:var(--bg-card); border-radius:20px; padding:1.75rem 2rem;
        box-shadow:var(--shadow); margin:1.5rem 0;
        display:flex; align-items:center; gap:2rem; flex-wrap:wrap;
    }
    .quality-gauge-wrap { position:relative; width:110px; height:110px; flex-shrink:0; }
    .quality-gauge { transform:rotate(-90deg); }
    .gauge-track { fill:none; stroke:#f0f0f0; stroke-width:10; }
    .gauge-fill  { fill:none; stroke-width:10; stroke-linecap:round; stroke-dasharray:283; stroke-dashoffset:283; transition:stroke-dashoffset 1.2s cubic-bezier(.16,1,.3,1), stroke 0.5s ease; }
    .gauge-label { position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; }
    .gauge-score { font-size:1.55rem; font-weight:700; color:var(--text-main); line-height:1; }
    .gauge-sub   { font-size:.62rem; color:var(--text-muted); font-weight:600; text-transform:uppercase; letter-spacing:.5px; }
    .quality-details { flex:1; min-width:200px; }
    .quality-title { font-weight:700; font-size:1rem; color:var(--text-main); margin-bottom:1rem; display:flex; align-items:center; gap:8px; }
    .quality-grade { padding:.2rem .65rem; border-radius:100px; font-size:.75rem; font-weight:700; }
    .quality-bars { display:flex; flex-direction:column; gap:.6rem; }
    .qb-row { display:flex; align-items:center; gap:.75rem; }
    .qb-label { font-size:.75rem; color:var(--text-muted); min-width:90px; }
    .qb-track { flex:1; height:7px; border-radius:4px; background:color-mix(in srgb, var(--text-muted) 12%, transparent); overflow:hidden; }
    .qb-fill  { height:100%; border-radius:4px; width:0; transition:width 1.1s cubic-bezier(.16,1,.3,1); }
    .qb-pct   { font-size:.73rem; font-weight:700; min-width:38px; text-align:right; }

    /* â•â•â•â•â•â•â•â•â•â•â•â• ACTION SUMMARY â•â•â•â•â•â•â•â•â•â•â•â• */
    .action-banner { background:var(--bg-card); border-radius:18px; padding:1.25rem 1.75rem; box-shadow:var(--shadow); margin:1.5rem 0; border-left:5px solid #20c997; }
    .action-banner-title { font-size:.82rem; font-weight:700; color:#20c997; text-transform:uppercase; letter-spacing:.9px; margin-bottom:.75rem; display:flex; align-items:center; gap:7px; }
    .action-tags { display:flex; flex-wrap:wrap; gap:.5rem; }
    .atag { display:inline-flex; align-items:center; gap:5px; font-size:.78rem; font-weight:600; padding:.3rem .8rem; border-radius:100px; }
    .atag.g { background:#dcfce7; color:#166534; }
    .atag.b { background:#dbeafe; color:#1e40af; }
    .atag.y { background:#fef9c3; color:#854d0e; }
    .atag.r { background:#fee2e2; color:#991b1b; }
    .atag.s { background:var(--bg-section); color:var(--text-muted); }

    /* â•â•â•â•â•â•â•â•â•â•â•â• BUTTONS â•â•â•â•â•â•â•â•â•â•â•â• */
    .btn-new {
        background:rgba(255,255,255,.15); backdrop-filter:blur(8px);
        color:white; border:2px solid rgba(255,255,255,.4);
        padding:.6rem 1.5rem; font-size:.88rem; font-weight:600;
        border-radius:50px; cursor:pointer; transition:all .3s ease;
        text-decoration:none; display:inline-flex; align-items:center; gap:7px;
    }
    .btn-new:hover { background:rgba(255,255,255,.28); color:white; transform:translateY(-2px); }

    .btn-download {
        background:var(--gradient-alt); color:white; border:none;
        padding:1rem 2.5rem; font-size:1.05rem; font-weight:600;
        border-radius:50px; cursor:pointer; transition:all .3s ease;
        box-shadow:0 8px 25px rgba(245,87,108,.3);
        text-decoration:none; display:inline-flex; align-items:center; gap:8px;
    }
    .btn-download:hover { transform:translateY(-3px); box-shadow:0 12px 35px rgba(245,87,108,.4); color:white; }

    .btn-copy {
        background:var(--bg-section); color:var(--text-muted); border:1px solid var(--border-col);
        padding:.55rem 1.2rem; font-size:.82rem; font-weight:600;
        border-radius:50px; cursor:pointer; transition:all .3s ease;
        display:inline-flex; align-items:center; gap:6px;
    }
    .btn-copy:hover { border-color:var(--primary); color:var(--primary); }

    /* â•â•â•â•â•â•â•â•â•â•â•â• TABLE â•â•â•â•â•â•â•â•â•â•â•â• */
    .table-container { background:var(--bg-card); border-radius:20px; padding:2rem; box-shadow:var(--shadow); margin:2rem 0; }
    .table-container h3 { color:var(--primary); font-weight:600; margin-bottom:1.5rem; text-align:center; }
    .table { color:var(--text-main); }
    .table thead { background:var(--gradient); color:white; }
    .table thead th { color:white !important; border:none; }
    .table tbody tr { transition:all .2s ease; }
    .table tbody tr:hover { background:color-mix(in srgb, var(--primary) 6%, transparent); }
    .dataTables_wrapper .dataTables_filter input,
    .dataTables_wrapper .dataTables_length select { background:var(--bg-section); color:var(--text-main); border:1px solid var(--border-col); border-radius:8px; }
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_paginate { color:var(--text-muted); }

    /* â•â•â•â•â•â•â•â•â•â•â•â• CHARTS â•â•â•â•â•â•â•â•â•â•â•â• */
    .chart-section { background:var(--bg-card); border-radius:20px; padding:2rem; box-shadow:var(--shadow); margin:2rem 0; }
    .chart-section h3 { color:var(--primary); font-weight:600; margin-bottom:2rem; text-align:center; }
    .chart-wrap { background:var(--bg-section); border-radius:15px; border:1px solid var(--border-col); overflow:hidden; transition:all .3s ease; }
    .chart-wrap:hover { transform:translateY(-5px); box-shadow:0 12px 30px rgba(103,126,234,.15); }
    .chart-head { padding:.7rem 1.1rem; border-bottom:1px solid var(--border-col); display:flex; align-items:center; justify-content:space-between; }
    .chart-col-name { font-size:.83rem; font-weight:700; color:var(--primary); }
    .chart-pill { font-size:.67rem; font-weight:700; padding:.18rem .52rem; border-radius:100px; background:rgba(111,66,193,.1); color:var(--primary); }
    .chart-body { padding:1.1rem; }

    /* â•â•â•â•â•â•â•â•â•â•â•â• COLUMN STATS â•â•â•â•â•â•â•â•â•â•â•â• */
    .col-stats-wrap { background:var(--bg-card); border-radius:20px; overflow:hidden; box-shadow:var(--shadow); margin:2rem 0; }
    .col-stats-head { background:var(--gradient); padding:1.4rem 2rem; color:white; }
    .col-stats-head h3 { margin:0; font-size:1.15rem; font-weight:600; }
    .col-stats-head p  { margin:.3rem 0 0; opacity:.8; font-size:.86rem; }
    .col-stats-tabs { display:flex; border-bottom:2px solid var(--border-col); background:var(--bg-section); padding:0 1.5rem; gap:.4rem; overflow-x:auto; }
    .ctab {
        padding:.75rem 1.1rem; border:none; background:transparent;
        font-family:'Poppins',sans-serif; font-size:.83rem; font-weight:500;
        color:var(--text-muted); cursor:pointer; border-bottom:3px solid transparent;
        margin-bottom:-2px; transition:all .25s; display:flex; align-items:center; gap:6px; white-space:nowrap;
    }
    .ctab:hover  { color:var(--primary); }
    .ctab.active { color:var(--primary); border-bottom-color:var(--primary); font-weight:700; }
    .ctab-count  { font-size:.67rem; padding:.14rem .4rem; border-radius:100px; font-weight:700; background:var(--primary); color:white; }
    .col-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(265px,1fr)); gap:1.1rem; padding:1.5rem; }
    .col-card { border:1px solid var(--border-col); border-radius:13px; overflow:hidden; background:var(--bg-card); transition:transform .25s,box-shadow .25s; }
    .col-card:hover { transform:translateY(-4px); box-shadow:0 12px 30px rgba(103,126,234,.14); border-color:rgba(103,126,234,.35); }
    .col-card-top { background:var(--bg-section); padding:.75rem 1rem; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--border-col); }
    .col-name { font-weight:700; font-size:.87rem; color:var(--primary); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:145px; }
    .col-type { font-size:.65rem; font-weight:700; padding:.18rem .52rem; border-radius:100px; text-transform:uppercase; letter-spacing:.4px; }
    .col-type.num { background:rgba(32,201,151,.12); color:#0ca678; border:1px solid rgba(32,201,151,.25); }
    .col-type.cat { background:rgba(13,202,240,.12); color:#0891b2; border:1px solid rgba(13,202,240,.25); }
    .col-card-body { padding:.95rem 1rem; display:flex; flex-direction:column; gap:.6rem; }
    .sr { display:flex; flex-direction:column; gap:.25rem; }
    .sr-top { display:flex; align-items:center; justify-content:space-between; font-size:.77rem; }
    .sr-lbl { color:var(--text-muted); font-weight:500; display:flex; align-items:center; gap:4px; }
    .sr-vals { display:flex; align-items:center; gap:5px; }
    .sc { font-weight:700; font-size:.83rem; padding:.11rem .44rem; border-radius:6px; }
    .sc.m { background:rgba(220,53,69,.1); color:#dc3545; }
    .sc.o { background:rgba(255,193,7,.15); color:#b8860b; }
    .sc.d { background:rgba(13,202,240,.1); color:#0891b2; }
    .sp { font-size:.7rem; color:var(--text-muted); }
    .sbt { height:5px; border-radius:3px; background:var(--bg-section); overflow:hidden; }
    .sbf { height:100%; border-radius:3px; width:0; transition:width 1s cubic-bezier(.16,1,.3,1); }
    .sbf.m { background:linear-gradient(90deg,#ff6b6b,#dc3545); }
    .sbf.o { background:linear-gradient(90deg,#ffd93d,#ffc107); }
    .sbf.d { background:linear-gradient(90deg,#74c0fc,#0dcaf0); }
    .col-status { display:flex; align-items:center; justify-content:center; padding:.42rem; border-top:1px solid var(--border-col); font-size:.74rem; font-weight:600; gap:4px; }
    .cs-ok   { color:#20c997; background:rgba(32,201,151,.06); }
    .cs-warn { color:#b8860b; background:rgba(255,193,7,.07); }
    .cs-bad  { color:#dc3545; background:rgba(220,53,69,.06); }
    .col-legend { display:flex; gap:.9rem; flex-wrap:wrap; padding:.65rem 1.5rem 1.2rem; border-top:1px solid var(--border-col); }
    .leg-item { display:flex; align-items:center; gap:5px; font-size:.77rem; color:var(--text-muted); }
    .leg-dot  { width:9px; height:9px; border-radius:50%; }
    .leg-dot.ok   { background:#20c997; }
    .leg-dot.warn { background:#ffc107; }
    .leg-dot.bad  { background:#dc3545; }

    /* â•â•â•â•â•â•â•â•â•â•â•â• FOOTER â•â•â•â•â•â•â•â•â•â•â•â• */
    .footer { background:rgba(255,255,255,.08); backdrop-filter:blur(10px); color:white; text-align:center; padding:2rem; margin-top:4rem; }
    .footer p { margin:0; opacity:.9; }

    /* â•â•â•â•â•â•â•â•â•â•â•â• RESPONSIVE â•â•â•â•â•â•â•â•â•â•â•â• */
    @media (max-width:768px) {
        .hero-title   { font-size:2rem; }
        .hero-subtitle{ font-size:1rem; }
        .step-card    { padding:1rem; }
        .step-number  { width:42px; height:42px; font-size:1.2rem; }
        .method-grid  { grid-template-columns:1fr 1fr; }
        .btn-submit   { padding:1rem 2rem; font-size:1rem; }
        .kpi-value    { font-size:1.8rem; }
        .card-header-custom h2 { font-size:1.5rem; }
        .col-grid     { grid-template-columns:1fr; }
        .loading-box  { min-width:280px; padding:2rem 1.5rem; }
        .quality-card { flex-direction:column; align-items:flex-start; }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â• KEYFRAMES â•â•â•â•â•â•â•â•â•â•â•â• */
    @keyframes fadeIn    { from{opacity:0} to{opacity:1} }
    @keyframes fadeInUp  { from{opacity:0;transform:translateY(30px)} to{opacity:1;transform:translateY(0)} }
    @keyframes fadeInDown{ from{opacity:0;transform:translateY(-30px)} to{opacity:1;transform:translateY(0)} }
    .animate-on-scroll { opacity:0; transform:translateY(30px); transition:all .6s ease; }
    .animate-on-scroll.visible { opacity:1; transform:translateY(0); }
    </style>
</head>
<body>

<!-- Scroll progress -->
<div id="scrollBar"></div>

<!-- Back to top -->
<button id="backToTop" aria-label="Retour en haut"><i class="bi bi-arrow-up"></i></button>

<!-- Toasts -->
<div class="toast-stack" id="toastStack"></div>

<!-- â•â•â•â•â•â•â•â•â•â• LOADING OVERLAY â•â•â•â•â•â•â•â•â•â• -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-box">
        <div class="ring-wrap"></div>
        <ul class="load-steps">
            <li class="load-step" id="ls1"><div class="ls-dot"><i class="bi bi-upload"></i></div> Lecture du fichier</li>
            <li class="load-step" id="ls2"><div class="ls-dot"><i class="bi bi-search"></i></div> DÃ©tection des anomalies</li>
            <li class="load-step" id="ls3"><div class="ls-dot"><i class="bi bi-magic"></i></div> Nettoyage des donnÃ©es</li>
            <li class="load-step" id="ls4"><div class="ls-dot"><i class="bi bi-bar-chart"></i></div> GÃ©nÃ©ration des statistiques</li>
        </ul>
        <div class="load-timer" id="loadTimer">0s</div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• NAVBAR â•â•â•â•â•â•â•â•â•â• -->
<nav class="navbar navbar-expand-lg sticky-top">
    <div class="container">
        <a class="navbar-brand" href="{% url 'index' %}"><i class="bi bi-stars"></i> Data Cleaner Pro</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto align-items-center gap-1">
                <li class="nav-item"><a class="nav-link" href="{% url 'index' %}">Accueil</a></li>
                <li class="nav-item"><a class="nav-link" href="#guide">Guide</a></li>
                <li class="nav-item"><a class="nav-link" href="#upload">Upload</a></li>
                <li class="nav-item" id="resultsNavItem" style="display:none">
                    <a class="nav-link" href="#results" style="color:var(--primary)!important;font-weight:700">
                        <i class="bi bi-graph-up"></i> RÃ©sultats
                    </a>
                </li>
                <li class="nav-item ms-2">
                    <button class="dark-toggle" id="darkToggle">
                        <i class="bi bi-moon-fill" id="darkIcon"></i>
                        <span id="darkLabel">Sombre</span>
                    </button>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â• HERO â•â•â•â•â•â•â•â•â•â• -->
<div class="hero-section">
    <div class="container">
        <h1 class="hero-title"><i class="bi bi-magic"></i> Nettoyage Intelligent de DonnÃ©es</h1>
        <p class="hero-subtitle">Transformez vos donnÃ©es brutes en donnÃ©es propres et exploitables en quelques clics</p>
        <div class="hero-pills">
            <span class="hero-pill"><i class="bi bi-filetype-csv"></i> CSV</span>
            <span class="hero-pill"><i class="bi bi-filetype-txt"></i> TXT</span>
            <span class="hero-pill"><i class="bi bi-file-earmark-excel"></i> XLS / XLSX</span>
            <span class="hero-pill"><i class="bi bi-filetype-json"></i> JSON</span>
            <span class="hero-pill"><i class="bi bi-file-earmark-code"></i> XML</span>
            <span class="hero-pill"><i class="bi bi-hdd"></i> Max 50 MB</span>
        </div>
    </div>
</div>

<div class="container pb-5">

    <!-- â•â•â•â•â•â•â•â•â•â• GUIDE â•â•â•â•â•â•â•â•â•â• -->
    <div class="guide-section" id="guide">
        <h2 class="text-white text-center mb-4"><i class="bi bi-lightbulb"></i> Comment Ã§a marche ?</h2>
        <div class="row">
            <div class="col-md-4 mb-3">
                <div class="step-card">
                    <div class="d-flex align-items-center">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h5><i class="bi bi-file-earmark-arrow-up"></i> Importez votre fichier</h5>
                            <p>Glissez-dÃ©posez ou sÃ©lectionnez votre fichier de donnÃ©es (CSV, Excel, JSON, XML)</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="step-card">
                    <div class="d-flex align-items-center">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h5><i class="bi bi-sliders"></i> Choisissez la mÃ©thode</h5>
                            <p>SÃ©lectionnez comment traiter les valeurs aberrantes dans vos donnÃ©es</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="step-card">
                    <div class="d-flex align-items-center">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h5><i class="bi bi-download"></i> TÃ©lÃ©chargez</h5>
                            <p>Obtenez vos donnÃ©es nettoyÃ©es avec statistiques et graphiques dÃ©taillÃ©s</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="text-center mt-4">
            <p class="text-white mb-2"><i class="bi bi-check-circle"></i> Suppression automatique des doublons</p>
            <p class="text-white mb-2"><i class="bi bi-check-circle"></i> Traitement intelligent des valeurs manquantes</p>
            <p class="text-white mb-0"><i class="bi bi-check-circle"></i> DÃ©tection et correction des valeurs aberrantes</p>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â• UPLOAD â•â•â•â•â•â•â•â•â•â• -->
    <div class="main-card animate-on-scroll" id="upload">
        <div class="card-header-custom">
            <h2><i class="bi bi-cloud-upload"></i> Importez vos donnÃ©es</h2>
            <p>Formats supportÃ©s : CSV, TXT, Excel (.xls, .xlsx), JSON, XML</p>
        </div>
        <div class="card-body p-4">
            <form method="POST" id="uploadForm">
                {% csrf_token %}

                <!-- Drop zone -->
                <div class="file-drop-zone" id="dropZone">
                    <input type="file" name="datafile" id="datafile" accept=".csv,.txt,.xls,.xlsx,.json,.xml">
                    <div class="file-info">
                        <div class="upload-icon"><i class="bi bi-cloud-arrow-up"></i></div>
                        <h4>Glissez-dÃ©posez votre fichier ici</h4>
                        <p class="text-muted">ou cliquez pour sÃ©lectionner</p>
                        <small class="text-muted"><i class="bi bi-info-circle"></i> Taille maximale : 50 MB</small>
                    </div>
                </div>
                <div id="fileNameDisplay" class="file-name-display">
                    <span style="display:flex;align-items:center;gap:8px">
                        <i class="bi bi-file-earmark-check" style="font-size:1.2rem;color:var(--primary)"></i>
                        <span class="fname" id="fileName"></span>
                    </span>
                    <span class="file-size-tag" id="fileSize"></span>
                </div>

                <!-- Methods -->
                <div class="method-section">
                    <h4 class="method-title"><i class="bi bi-gear"></i> MÃ©thode de traitement des valeurs aberrantes</h4>
                    <div class="method-grid">
                        <div class="method-option">
                            <input type="radio" name="outlier_method" id="iqr" value="iqr" checked>
                            <label class="method-label" for="iqr">
                                <span class="method-icon">ğŸ“Š</span>
                                <strong>Winsorisation</strong>
                                <small>Plafonne les valeurs extrÃªmes aux bornes IQR. Conserve toutes les lignes.</small>
                            </label>
                        </div>
                        <div class="method-option">
                            <input type="radio" name="outlier_method" id="median" value="median">
                            <label class="method-label" for="median">
                                <span class="method-icon">ğŸ“ˆ</span>
                                <strong>MÃ©diane</strong>
                                <small>Remplace chaque outlier par la mÃ©diane de sa colonne.</small>
                            </label>
                        </div>
                        <div class="method-option">
                            <input type="radio" name="outlier_method" id="log" value="log">
                            <label class="method-label" for="log">
                                <span class="method-icon">ğŸ“‰</span>
                                <strong>Logarithmique</strong>
                                <small>Applique log(1+x). IdÃ©al pour donnÃ©es trÃ¨s asymÃ©triques.</small>
                            </label>
                        </div>
                        <div class="method-option">
                            <input type="radio" name="outlier_method" id="delete" value="delete">
                            <label class="method-label" for="delete">
                                <span class="method-icon">ğŸ—‘ï¸</span>
                                <strong>Suppression</strong>
                                <small>Supprime les lignes contenant des outliers.</small>
                            </label>
                        </div>
                        <div class="method-option">
                            <input type="radio" name="outlier_method" id="none" value="none">
                            <label class="method-label" for="none">
                                <span class="method-icon">â­ï¸</span>
                                <strong>Aucune action</strong>
                                <small>Conserve les outliers pour exploration libre.</small>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-4">
                    <button type="submit" class="btn-submit" id="submitBtn">
                        <span><i class="bi bi-rocket-takeoff"></i> Nettoyer mes donnÃ©es</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â• RESULTS â•â•â•â•â•â•â•â•â•â• -->
    <div id="results" style="display:none">

        <!-- Top bar -->
        <div class="results-topbar">
            <h2><i class="bi bi-graph-up"></i> RÃ©sumÃ© des donnÃ©es nettoyÃ©es</h2>
            <a href="#upload" class="btn-new" id="btnNew"><i class="bi bi-arrow-counterclockwise"></i> Nouvelle analyse</a>
        </div>

        <!-- KPI cards -->
        <div class="summary-section animate-on-scroll">
            <div class="row g-3" id="summaryCards"></div>
        </div>

        <!-- Quality score -->
        <div class="quality-card animate-on-scroll" id="qualityCard" style="display:none">
            <div class="quality-gauge-wrap">
                <svg class="quality-gauge" width="110" height="110" viewBox="0 0 110 110">
                    <circle class="gauge-track" cx="55" cy="55" r="45"/>
                    <circle class="gauge-fill" id="gaugeFill" cx="55" cy="55" r="45"/>
                </svg>
                <div class="gauge-label">
                    <span class="gauge-score" id="gaugeScore">â€”</span>
                    <span class="gauge-sub">/ 100</span>
                </div>
            </div>
            <div class="quality-details">
                <div class="quality-title">
                    Score de qualitÃ©
                    <span class="quality-grade" id="qualityGrade"></span>
                </div>
                <div class="quality-bars">
                    <div class="qb-row">
                        <span class="qb-label">ComplÃ©tude</span>
                        <div class="qb-track"><div class="qb-fill" id="qbComplete" style="background:#20c997"></div></div>
                        <span class="qb-pct" id="qbCompletePct" style="color:#20c997">â€”</span>
                    </div>
                    <div class="qb-row">
                        <span class="qb-label">UnicitÃ©</span>
                        <div class="qb-track"><div class="qb-fill" id="qbUnique" style="background:#667eea"></div></div>
                        <span class="qb-pct" id="qbUniquePct" style="color:#667eea">â€”</span>
                    </div>
                    <div class="qb-row">
                        <span class="qb-label">CohÃ©rence</span>
                        <div class="qb-track"><div class="qb-fill" id="qbConsist" style="background:#f093fb"></div></div>
                        <span class="qb-pct" id="qbConsistPct" style="color:#f093fb">â€”</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action summary -->
        <div class="action-banner animate-on-scroll" id="actionBanner" style="display:none">
            <div class="action-banner-title"><i class="bi bi-check-circle-fill"></i> Actions effectuÃ©es</div>
            <div class="action-tags" id="actionTags"></div>
        </div>

        <!-- Column stats -->
        <div class="col-stats-wrap animate-on-scroll" id="colStatsSection" style="display:none">
            <div class="col-stats-head">
                <h3><i class="bi bi-bar-chart-line-fill"></i> Analyse dÃ©taillÃ©e par colonne</h3>
                <p>Anomalies dÃ©tectÃ©es avant nettoyage â€” nombre et pourcentage</p>
            </div>
            <div class="col-stats-tabs">
                <button class="ctab active" onclick="filterCards('all',this)">
                    <i class="bi bi-grid-3x3-gap-fill"></i> Toutes <span class="ctab-count" id="tAll">0</span>
                </button>
                <button class="ctab" onclick="filterCards('m',this)">
                    <i class="bi bi-exclamation-triangle-fill" style="color:#dc3545"></i> Manquantes
                    <span class="ctab-count" id="tM" style="background:#dc3545">0</span>
                </button>
                <button class="ctab" onclick="filterCards('o',this)">
                    <i class="bi bi-graph-up-arrow" style="color:#b8860b"></i> Aberrantes
                    <span class="ctab-count" id="tO" style="background:#ffc107;color:#212529">0</span>
                </button>
                <button class="ctab" onclick="filterCards('d',this)">
                    <i class="bi bi-files" style="color:#0891b2"></i> Doublons
                    <span class="ctab-count" id="tD" style="background:#0dcaf0;color:#212529">0</span>
                </button>
            </div>
            <div class="col-grid" id="colGrid"></div>
            <div class="col-legend">
                <div class="leg-item"><div class="leg-dot ok"></div> &lt; 5% Acceptable</div>
                <div class="leg-item"><div class="leg-dot warn"></div> 5â€“20% Attention</div>
                <div class="leg-item"><div class="leg-dot bad"></div> â‰¥ 20% Critique</div>
            </div>
        </div>

        <!-- Data table -->
        <div class="table-container animate-on-scroll">
            <h3><i class="bi bi-table"></i> AperÃ§u des donnÃ©es nettoyÃ©es</h3>
            <div class="table-responsive">
                <table id="dataTable" class="table table-hover"></table>
            </div>
            <div class="text-center mt-4" style="display:flex;flex-wrap:wrap;align-items:center;justify-content:center;gap:1rem">
                <a href="{% url 'download_cleaned' %}" class="btn-download">
                    <i class="bi bi-download"></i> TÃ©lÃ©charger le fichier nettoyÃ©
                </a>
                <button class="btn-copy" id="copyBtn"><i class="bi bi-clipboard"></i> Copier les donnÃ©es</button>
                <a href="#upload" class="btn-copy" style="text-decoration:none"><i class="bi bi-arrow-counterclockwise"></i> Nouvelle analyse</a>
            </div>
        </div>

        <!-- Charts -->
        <div class="chart-section animate-on-scroll" id="chartsSection" style="display:none">
            <h3><i class="bi bi-bar-chart"></i> Statistiques visuelles</h3>
            <div class="row g-4" id="chartsContainer"></div>
        </div>

    </div><!-- /results -->
</div>

<!-- Footer -->
<div class="footer">
    <div class="container">
        <p><i class="bi bi-heart-fill text-danger"></i> Data Cleaner Pro â€” KHALILOU TANDIA Â© 2026</p>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* â•â•â•â•â•â•â•â•â•â• SCROLL PROGRESS + BACK TO TOP â•â•â•â•â•â•â•â•â•â• */
window.addEventListener('scroll', () => {
    const d = document.documentElement;
    document.getElementById('scrollBar').style.width = (d.scrollTop / (d.scrollHeight - d.clientHeight) * 100) + '%';
    const btn = document.getElementById('backToTop');
    btn.classList.toggle('show', window.scrollY > 400);
});
document.getElementById('backToTop').addEventListener('click', () => window.scrollTo({ top:0, behavior:'smooth' }));

/* â•â•â•â•â•â•â•â•â•â• DARK MODE â•â•â•â•â•â•â•â•â•â• */
const darkToggle = document.getElementById('darkToggle');
const darkIcon   = document.getElementById('darkIcon');
const darkLabel  = document.getElementById('darkLabel');
let isDark = localStorage.getItem('dcTheme') === 'dark';

function applyTheme() {
    document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
    darkIcon.className  = isDark ? 'bi bi-sun-fill' : 'bi bi-moon-fill';
    darkLabel.textContent = isDark ? 'Clair' : 'Sombre';
    localStorage.setItem('dcTheme', isDark ? 'dark' : 'light');
}
applyTheme();
darkToggle.addEventListener('click', () => { isDark = !isDark; applyTheme(); });

/* â•â•â•â•â•â•â•â•â•â• TOAST â•â•â•â•â•â•â•â•â•â• */
function toast(title, msg, type='info') {
    const map = { info:['bi-info-circle-fill','#6f42c1'], error:['bi-x-circle-fill','#dc3545'], success:['bi-check-circle-fill','#20c997'], warn:['bi-exclamation-triangle-fill','#ffc107'] };
    const [ico, col] = map[type] || map.info;
    const el = document.createElement('div');
    el.className = `toast-item t-${type}`;
    el.style.borderLeftColor = col;
    el.innerHTML = `<div class="ti-icon" style="color:${col}"><i class="bi ${ico}"></i></div>
        <div class="ti-body"><div class="ti-title">${title}</div><div class="ti-msg">${msg}</div></div>
        <button class="ti-close" onclick="this.parentElement.remove()"><i class="bi bi-x"></i></button>`;
    document.getElementById('toastStack').appendChild(el);
    setTimeout(() => { el.style.animation='tOut .35s ease forwards'; setTimeout(()=>el.remove(), 360); }, 5000);
}

/* â•â•â•â•â•â•â•â•â•â• LOADING â•â•â•â•â•â•â•â•â•â• */
let _timerInt=null, _stepInt=null, _elapsed=0;
function startLoad() {
    const steps = ['ls1','ls2','ls3','ls4'];
    steps.forEach(id => { const el=document.getElementById(id); el.classList.remove('active','done'); });
    document.getElementById(steps[0]).classList.add('active');
    _elapsed = 0;
    document.getElementById('loadTimer').textContent = '0s';
    _timerInt = setInterval(() => { _elapsed++; document.getElementById('loadTimer').textContent = _elapsed+'s'; }, 1000);
    let cur = 0;
    _stepInt = setInterval(() => {
        if (cur < steps.length - 1) {
            const d=document.getElementById(steps[cur]); d.classList.remove('active'); d.classList.add('done'); d.querySelector('.ls-dot').innerHTML='<i class="bi bi-check"></i>';
            cur++;
            document.getElementById(steps[cur]).classList.add('active');
        }
    }, 1900);
    document.getElementById('loadingOverlay').classList.add('show');
}
function stopLoad() {
    clearInterval(_timerInt); clearInterval(_stepInt);
    ['ls1','ls2','ls3','ls4'].forEach(id => {
        const el=document.getElementById(id); el.classList.remove('active'); el.classList.add('done');
        el.querySelector('.ls-dot').innerHTML='<i class="bi bi-check"></i>';
    });
    setTimeout(() => document.getElementById('loadingOverlay').classList.remove('show'), 450);
}

/* â•â•â•â•â•â•â•â•â•â• FILTER TABS (global) â•â•â•â•â•â•â•â•â•â• */
function filterCards(type, btn) {
    document.querySelectorAll('.ctab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.col-card').forEach(c => {
        c.style.display = (type==='all' || parseInt(c.dataset[type]||0)>0) ? '' : 'none';
    });
}

/* â•â•â•â•â•â•â•â•â•â• CSRF â•â•â•â•â•â•â•â•â•â• */
function getCookie(n) {
    let v=null;
    document.cookie.split(';').forEach(c=>{ c=c.trim(); if(c.startsWith(n+'=')) v=decodeURIComponent(c.slice(n.length+1)); });
    return v;
}
const csrf = getCookie('csrftoken');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
$(document).ready(function() {
    const MAX = 50;
    const dropZone  = document.getElementById('dropZone');
    const fileInput = document.getElementById('datafile');

    /* â”€â”€ File selection â”€â”€ */
    function handleFile(file) {
        const mb = file.size / 1024 / 1024;
        if (mb > MAX) {
            dropZone.classList.add('has-error');
            fileInput.value = '';
            document.getElementById('fileNameDisplay').classList.remove('show');
            toast('Fichier trop volumineux', `${mb.toFixed(1)} MB dÃ©tectÃ©s. Limite : ${MAX} MB.`, 'error');
            return;
        }
        dropZone.classList.remove('has-error');
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileSize').textContent = mb < 1 ? Math.round(file.size/1024)+'  KB' : mb.toFixed(1)+' MB';
        document.getElementById('fileNameDisplay').classList.add('show');
        toast('Fichier prÃªt', `${file.name} sÃ©lectionnÃ©.`, 'success');
    }

    fileInput.addEventListener('change', function() { if (this.files[0]) handleFile(this.files[0]); });
    dropZone.addEventListener('dragover',  e=>{ e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', e=>{ e.preventDefault(); dropZone.classList.remove('dragover'); });
    dropZone.addEventListener('drop', e=>{ e.preventDefault(); dropZone.classList.remove('dragover'); if(e.dataTransfer.files[0]){ fileInput.files=e.dataTransfer.files; handleFile(e.dataTransfer.files[0]); } });

    /* â”€â”€ Submit â”€â”€ */
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
        e.preventDefault();
        if (!fileInput.files || !fileInput.files[0]) { toast('Aucun fichier', 'Veuillez sÃ©lectionner un fichier.', 'warn'); return; }
        document.getElementById('submitBtn').disabled = true;
        startLoad();

        $.ajax({
            url:"{% url 'upload_file' %}", type:'POST',
            data:new FormData(this), processData:false, contentType:false,
            headers:{'X-CSRFToken':csrf},
            success(response) {
                stopLoad();
                document.getElementById('submitBtn').disabled = false;
                if (response?.data?.length > 0) {
                    displayResults(response);
                    document.getElementById('resultsNavItem').style.display='block';
                    toast('Nettoyage terminÃ© !', `${response.data.length} lignes traitÃ©es en ${_elapsed}s.`, 'success');
                    setTimeout(()=>document.getElementById('results').scrollIntoView({behavior:'smooth',block:'start'}), 350);
                } else {
                    toast('Aucune donnÃ©e', 'Le fichier ne contient aucune donnÃ©e exploitable.', 'warn');
                }
            },
            error(xhr) {
                stopLoad();
                document.getElementById('submitBtn').disabled = false;
                toast('Erreur', xhr.responseJSON?.error || 'Erreur lors du nettoyage.', 'error');
            }
        });
    });

    /* â”€â”€ Copy data â”€â”€ */
    document.getElementById('copyBtn')?.addEventListener('click', function() {
        const table = document.getElementById('dataTable');
        if (!table) return;
        const rows = Array.from(table.querySelectorAll('tr')).map(r =>
            Array.from(r.querySelectorAll('th,td')).map(c=>c.textContent.trim()).join('\t')
        );
        navigator.clipboard.writeText(rows.join('\n')).then(() => {
            toast('CopiÃ© !', 'Les donnÃ©es ont Ã©tÃ© copiÃ©es dans le presse-papier.', 'success');
        });
    });

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DISPLAY RESULTS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function displayResults(response) {
        const data  = response.data;
        const stats = response.stats || {};
        document.getElementById('results').style.display = 'block';
        displaySummaryCards(data, stats);
        displayQualityScore(data, stats);
        displayActionBanner(data, stats);
        displayColumnStats(data, stats);
        displayDataTable(data);
        if (Object.keys(stats).length) displayCharts(stats);
        document.querySelectorAll('.animate-on-scroll:not(.visible)').forEach(el=>observer.observe(el));
    }

    /* â”€â”€ KPI cards (individual colors) â”€â”€ */
    function displaySummaryCards(data, stats) {
        const numRows = data.length;
        const numCols = Object.keys(data[0]||{}).length;
        let missing=0, outliers=0, dups=0, dupFound=false;
        Object.values(stats).forEach(s=>{
            if (s.missing!==undefined)  missing  += s.missing;
            if (s.outliers!==undefined) outliers += s.outliers;
            if (!dupFound && s.duplicates!==undefined) { dups=s.duplicates; dupFound=true; }
        });

        const kpis = [
            { v:numRows,   label:'Lignes nettoyÃ©es', icon:'bi-table',             kc:'#667eea' },
            { v:numCols,   label:'Colonnes',          icon:'bi-columns',            kc:'#20c997' },
            { v:missing,   label:'Val. Manquantes',   icon:'bi-exclamation-circle', kc:'#f5576c' },
            { v:dups,      label:'Doublons',           icon:'bi-files',              kc:'#ffc107' },
            { v:outliers,  label:'Aberrantes',         icon:'bi-graph-down-arrow',   kc:'#fd7e14' },
        ];
        document.getElementById('summaryCards').innerHTML = kpis.map(k=>`
            <div class="col-6 col-md-4 col-lg">
                <div class="kpi-card" style="--kc:${k.kc}">
                    <div class="kpi-icon"><i class="bi ${k.icon}"></i></div>
                    <div class="kpi-value">${k.v.toLocaleString('fr')}</div>
                    <div class="kpi-label">${k.label}</div>
                </div>
            </div>`).join('');
    }

    /* â”€â”€ Quality Score â”€â”€ */
    function displayQualityScore(data, stats) {
        const total = data.length;
        if (!total) return;
        const numCols = Object.keys(data[0]||{}).length;
        const totalCells = total * numCols;
        let missing=0, dups=0, outliers=0, dupFound=false;
        Object.values(stats).forEach(s=>{
            if (s.missing!==undefined)  missing  += s.missing;
            if (s.outliers!==undefined) outliers += s.outliers;
            if (!dupFound && s.duplicates!==undefined){ dups=s.duplicates; dupFound=true; }
        });

        const complet = Math.max(0, (1 - missing/totalCells)    * 100);
        const unique  = Math.max(0, (1 - dups/total)            * 100);
        const consist = Math.max(0, (1 - outliers/(totalCells||1))* 100);
        const score   = Math.round(complet*.4 + unique*.3 + consist*.3);

        const gradeMap = score>=85?['Excellent','#20c997']:score>=70?['Bon','#667eea']:score>=50?['Moyen','#ffc107']:['Critique','#dc3545'];
        const [grade, col] = gradeMap;

        document.getElementById('gaugeScore').textContent = score;
        document.getElementById('qualityGrade').textContent = grade;
        document.getElementById('qualityGrade').style.cssText = `background:${col}22;color:${col};`;

        // Animate gauge
        const circ = 2 * Math.PI * 45;
        const fill  = document.getElementById('gaugeFill');
        fill.style.stroke = col;
        setTimeout(()=>{ fill.style.strokeDashoffset = circ - (circ * score / 100); }, 200);

        // Progress bars
        function setQB(id, pId, val, col) {
            document.getElementById(id).style.width = val.toFixed(1) + '%';
            document.getElementById(pId).textContent = val.toFixed(0) + '%';
        }
        setTimeout(()=>{
            setQB('qbComplete','qbCompletePct', complet,'#20c997');
            setQB('qbUnique',  'qbUniquePct',   unique, '#667eea');
            setQB('qbConsist', 'qbConsistPct',  consist,'#f093fb');
        }, 300);

        document.getElementById('qualityCard').style.display = 'flex';
    }

    /* â”€â”€ Action Banner â”€â”€ */
    function displayActionBanner(data, stats) {
        let missing=0, outliers=0, dups=0, numC=0, catC=0, dupFound=false;
        Object.values(stats).forEach(s=>{
            if (s.missing!==undefined) missing+=s.missing;
            if (s.outliers!==undefined) outliers+=s.outliers;
            if (!dupFound && s.duplicates!==undefined){ dups=s.duplicates; dupFound=true; }
            if (s.mean!==undefined) numC++; else catC++;
        });
        const method   = document.querySelector('input[name="outlier_method"]:checked')?.value||'iqr';
        const mNames   = {iqr:'Winsorisation',median:'MÃ©diane',log:'Log',delete:'Suppression',none:'Aucune'};
        const tags = [
            `<span class="atag g"><i class="bi bi-check-circle"></i>${data.length.toLocaleString('fr')} lignes disponibles</span>`,
            missing>0
                ? `<span class="atag b"><i class="bi bi-patch-check"></i>${missing} val. manquantes comblÃ©es</span>`
                : `<span class="atag s"><i class="bi bi-check2"></i>Aucune valeur manquante</span>`,
            dups>0 ? `<span class="atag y"><i class="bi bi-files"></i>${dups} doublons supprimÃ©s</span>` : '',
            outliers>0 ? `<span class="atag r"><i class="bi bi-graph-up-arrow"></i>${outliers} outliers â€” ${mNames[method]}</span>` : '',
            numC>0 ? `<span class="atag s"><i class="bi bi-calculator"></i>${numC} col. numÃ©riques</span>` : '',
            catC>0 ? `<span class="atag s"><i class="bi bi-alphabet"></i>${catC} col. catÃ©gorielles</span>` : '',
        ].filter(Boolean);
        document.getElementById('actionTags').innerHTML = tags.join('');
        document.getElementById('actionBanner').style.display = 'block';
    }

    /* â”€â”€ Column stats cards â”€â”€ */
    function displayColumnStats(data, stats) {
        if (!stats||!Object.keys(stats).length) return;
        const total = data.length;
        const grid  = document.getElementById('colGrid');
        grid.innerHTML = '';
        let tc=0,cM=0,cO=0,cD=0;

        Object.entries(stats).forEach(([col, s]) => {
            tc++;
            const m = s.missing||0, o=s.outliers||0, d=s.duplicates||0;
            const mp = s.missing_pct    ??+(m/total*100).toFixed(2);
            const op = s.outliers_pct   ??+(o/total*100).toFixed(2);
            const dp = s.duplicates_pct ??+(d/total*100).toFixed(2);
            if(m>0)cM++; if(o>0)cO++; if(d>0)cD++;
            const isNum = s.mean!==undefined;
            const mx    = Math.max(mp,op,dp);
            const [stCls,stTxt] = mx>=20?['cs-bad','âš ï¸ Critique']:mx>=5?['cs-warn','âš  Attention']:['cs-ok','âœ“ Bonne qualitÃ©'];

            const card = document.createElement('div');
            card.className='col-card'; card.dataset.m=m; card.dataset.o=o; card.dataset.d=d;
            card.innerHTML=`
                <div class="col-card-top">
                    <span class="col-name" title="${col}">${col}</span>
                    <span class="col-type ${isNum?'num':'cat'}">${isNum?'Num.':'Cat.'}</span>
                </div>
                <div class="col-card-body">
                    ${sRow('bi-exclamation-circle-fill','#dc3545','Manquantes','m',m,mp)}
                    ${sRow('bi-graph-up-arrow','#b8860b','Aberrantes','o',o,op)}
                    ${sRow('bi-files','#0891b2','Doublons','d',d,dp)}
                </div>
                <div class="col-status ${stCls}">${stTxt}</div>`;
            grid.appendChild(card);
        });

        document.getElementById('tAll').textContent=tc;
        document.getElementById('tM').textContent=cM;
        document.getElementById('tO').textContent=cO;
        document.getElementById('tD').textContent=cD;
        document.getElementById('colStatsSection').style.display='block';
        setTimeout(()=>{ document.querySelectorAll('.sbf').forEach(b=>{ b.style.width=Math.min(parseFloat(b.dataset.p||0),100)+'%'; }); },220);
    }

    function sRow(icon, col, label, cls, count, pct) {
        return `<div class="sr">
            <div class="sr-top">
                <span class="sr-lbl"><i class="bi ${icon}" style="color:${col}"></i>${label}</span>
                <div class="sr-vals"><span class="sc ${cls}">${count}</span><span class="sp">${pct}%</span></div>
            </div>
            <div class="sbt"><div class="sbf ${cls}" data-p="${pct}"></div></div>
        </div>`;
    }

    /* â”€â”€ DataTable â”€â”€ */
    function displayDataTable(data) {
        if ($.fn.DataTable.isDataTable('#dataTable')) $('#dataTable').DataTable().destroy();
        const columns = Object.keys(data[0]).map(col=>({title:col,data:col}));
        $('#dataTable').DataTable({
            data,columns,pageLength:10,
            language:{
                search:'_INPUT_',searchPlaceholder:'Rechercher...',
                lengthMenu:'Afficher _MENU_ lignes',
                info:'_START_â€“_END_ sur _TOTAL_ lignes',
                infoEmpty:'Aucune ligne',infoFiltered:'(filtrÃ©: _MAX_)',
                paginate:{first:'Â«',last:'Â»',next:'â€º',previous:'â€¹'}
            },
            responsive:true
        });
    }

    /* â”€â”€ Charts : bar + radar (remplace le doughnut sans sens) â”€â”€ */
    function displayCharts(stats) {
        const container = document.getElementById('chartsContainer');
        container.innerHTML=''; let hasNum=false,idx=0;
        const pal  = ['rgba(103,126,234,.85)','rgba(118,75,162,.85)','rgba(32,201,151,.85)','rgba(255,193,7,.85)','rgba(220,53,69,.85)'];
        const bord = pal.map(c=>c.replace('.85','1'));

        Object.entries(stats).forEach(([col,cs])=>{
            if (cs.mean===undefined) return;
            hasNum=true;
            const bId=`cb${idx}`, rId=`cr${idx}`;
            container.innerHTML+=`
                <div class="col-lg-6">
                    <div class="chart-wrap">
                        <div class="chart-head">
                            <span class="chart-col-name"><i class="bi bi-bar-chart-fill"></i> ${col}</span>
                            <span class="chart-pill">Distribution</span>
                        </div>
                        <div class="chart-body"><canvas id="${bId}"></canvas></div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="chart-wrap">
                        <div class="chart-head">
                            <span class="chart-col-name"><i class="bi bi-pentagon-fill"></i> ${col}</span>
                            <span class="chart-pill">Profil statistique</span>
                        </div>
                        <div class="chart-body"><canvas id="${rId}"></canvas></div>
                    </div>
                </div>`;

            setTimeout(()=>{
                // Bar
                new Chart(document.getElementById(bId),{
                    type:'bar',
                    data:{labels:['Moyenne','MÃ©diane','Min','Max','Ã‰cart-type'],
                          datasets:[{data:[cs.mean,cs.median,cs.min,cs.max,cs.std],backgroundColor:pal,borderColor:bord,borderWidth:2,borderRadius:10,borderSkipped:false}]},
                    options:{responsive:true,plugins:{legend:{display:false},
                        title:{display:true,text:col,font:{size:13,weight:'bold'},color:'#6f42c1'},
                        tooltip:{backgroundColor:'rgba(0,0,0,.82)',padding:10,callbacks:{label:c=>`${c.label}: ${(c.parsed.y??0).toFixed(2)}`}}},
                        scales:{y:{beginAtZero:false,grid:{color:'rgba(0,0,0,.04)'}},x:{grid:{display:false}}},
                        animation:{duration:1400,easing:'easeInOutQuart'}}
                });
                // Radar (profil normalisÃ© â€” bien plus pertinent que le doughnut)
                const vals=[cs.mean,cs.median,cs.std,cs.max,cs.min].map(v=>v??0);
                const mx=Math.max(...vals.map(Math.abs),.001);
                new Chart(document.getElementById(rId),{
                    type:'radar',
                    data:{labels:['Moyenne','MÃ©diane','Ã‰cart-type','Max','Min'],
                          datasets:[{data:vals.map(v=>+(v/mx*100).toFixed(1)),
                            backgroundColor:'rgba(103,126,234,.18)',borderColor:'#667eea',borderWidth:2,
                            pointRadius:5,pointBackgroundColor:'#764ba2',pointBorderColor:'#fff',pointBorderWidth:2}]},
                    options:{responsive:true,plugins:{legend:{display:false},
                        title:{display:true,text:`${col} â€” normalisÃ©`,font:{size:13,weight:'bold'},color:'#6f42c1'},
                        tooltip:{backgroundColor:'rgba(0,0,0,.82)',padding:10,callbacks:{label:c=>`${c.label}: ${c.parsed.r.toFixed(1)} %`}}},
                        scales:{r:{beginAtZero:true,max:100,grid:{color:'rgba(0,0,0,.06)'},ticks:{display:false},
                            pointLabels:{font:{size:10,weight:'600'},color:'#888'}}},
                        animation:{duration:1600,easing:'easeInOutQuart'}}
                });
            },120);
            idx++;
        });
        if (hasNum) document.getElementById('chartsSection').style.display='block';
    }

    /* â”€â”€ Scroll animations â”€â”€ */
    const observer = new IntersectionObserver(entries=>{
        entries.forEach(e=>{ if(e.isIntersecting) e.target.classList.add('visible'); });
    },{threshold:.08,rootMargin:'0px 0px -40px 0px'});
    document.querySelectorAll('.animate-on-scroll').forEach(el=>observer.observe(el));

    /* â”€â”€ Smooth scroll â”€â”€ */
    document.querySelectorAll('a[href^="#"]').forEach(a=>{
        a.addEventListener('click',e=>{
            const t=document.querySelector(a.getAttribute('href'));
            if(t){e.preventDefault();t.scrollIntoView({behavior:'smooth',block:'start'});}
        });
    });

}); // end ready
</script>
</body>
</html>